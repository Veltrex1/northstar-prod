generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id        String   @id @default(uuid())
  name      String
  industry  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users            User[]
  integrations     Integration[]
  documents        Document[]
  knowledgeEntries KnowledgeEntry[]
  conversations    Conversation[]
  boardReports     BoardReport[]
  emails           Email[]
  calendarEvents   CalendarEvent[]
  dailyDigests     DailyDigest[]
  followUps        FollowUp[]
  memories         ConversationMemory[]
  contacts         Contact[]

  @@map("companies")
}

model User {
  id                    String    @id @default(uuid())
  email                 String    @unique
  name                  String
  passwordHash          String?
  role                  UserRole  @default(CSUITE)
  companyId             String
  emailStyleProfile     Json?
  personalityProfile    Json?
  voiceProfile          Json?
  nickname              String?
  onboardingCompleted   Boolean   @default(false)
  onboardingCompletedAt DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  company           Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  conversations     Conversation[]
  emailDrafts       EmailDraft[]
  emails            Email[]
  boardReports      BoardReport[]
  monthlyTokenUsage UserMonthlyUsage[]
  calendarEvents    CalendarEvent[]
  dailyDigests      DailyDigest[]
  followUps         FollowUp[]
  memories          ConversationMemory[]
  contacts          Contact[]

  @@index([companyId])
  @@index([email])
  @@map("users")
}

model UserMonthlyUsage {
  id           String   @id @default(uuid())
  userId       String
  monthStart   DateTime
  outputTokens Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, monthStart])
  @@index([monthStart])
  @@map("user_monthly_usage")
}

enum UserRole {
  OWNER
  CSUITE
  DEPARTMENT_HEAD
  EMPLOYEE
}

model Integration {
  id            String            @id @default(uuid())
  companyId     String
  platform      Platform
  credentials   String
  status        IntegrationStatus @default(CONNECTED)
  lastSyncAt    DateTime?
  syncFrequency String            @default("realtime")
  metadata      Json?
  syncSettings  Json?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  company   Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  documents Document[]

  @@unique([companyId, platform])
  @@index([companyId])
  @@index([status])
  @@map("integrations")
}

enum Platform {
  GOOGLE_WORKSPACE
  MICROSOFT_365
  SLACK
  SALESFORCE
  QUICKBOOKS
  GOOGLE_CALENDAR
  MICROSOFT_CALENDAR
}

enum IntegrationStatus {
  CONNECTED
  SYNCING
  ERROR
  DISCONNECTED
}

enum CalendarProvider {
  GOOGLE
  MICROSOFT
}

enum EventStatus {
  CONFIRMED
  TENTATIVE
  CANCELLED
}

model CalendarEvent {
  id          String           @id @default(uuid())
  companyId   String
  userId      String
  eventId     String           @unique
  provider    CalendarProvider
  title       String
  description String?          @db.Text
  startTime   DateTime
  endTime     DateTime
  attendees   String[]
  location    String?
  meetingUrl  String?
  status      EventStatus      @default(CONFIRMED)
  briefId     String?          @unique
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  company      Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  brief        MeetingBrief?        @relation("CalendarEventBrief", fields: [briefId], references: [id])
  meetingBrief MeetingBrief?        @relation("MeetingBriefEvent")
  interactions ContactInteraction[]

  @@map("calendar_events")
}

model MeetingBrief {
  id              String    @id @default(uuid())
  eventId         String    @unique
  content         String    @db.Text
  attendeeContext Json
  talkingPoints   String[]
  questions       String[]
  relevantDocs    Json
  generatedAt     DateTime  @default(now())
  viewedAt        DateTime?

  event              CalendarEvent  @relation("MeetingBriefEvent", fields: [eventId], references: [id], onDelete: Cascade)
  calendarEventBrief CalendarEvent? @relation("CalendarEventBrief")

  @@map("meeting_briefs")
}

model Document {
  id              String   @id @default(uuid())
  companyId       String
  integrationId   String
  externalId      String
  title           String
  content         String   @db.Text
  contentType     String
  sourceUrl       String?
  metadata        Json
  authorityWeight Float    @default(1.0)
  isExcluded      Boolean  @default(false)
  createdAt       DateTime
  updatedAt       DateTime

  company          Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  integration      Integration      @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  knowledgeEntries KnowledgeEntry[]

  @@unique([integrationId, externalId])
  @@index([companyId])
  @@index([integrationId])
  @@index([isExcluded])
  @@map("documents")
}

model KnowledgeEntry {
  id              String   @id @default(uuid())
  companyId       String
  documentId      String?
  content         String   @db.Text
  embedding       String
  dataType        DataType
  authorityWeight Float    @default(1.0)
  version         Int      @default(1)
  metadata        Json?
  createdAt       DateTime @default(now())

  company  Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  document Document? @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([dataType])
  @@index([documentId])
  @@map("knowledge_entries")
}

enum DataType {
  FINANCIAL
  STRATEGIC
  PRODUCT
  OPERATIONAL
  COMMUNICATION
}

model Conversation {
  id             String   @id @default(uuid())
  companyId      String
  userId         String
  title          String?
  messages       Json
  useSecondBrain Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  company   Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user      User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  followUps FollowUp[]
  memories  ConversationMemory[]

  @@index([companyId])
  @@index([userId])
  @@index([updatedAt])
  @@map("conversations")
}

model DailyDigest {
  id          String    @id @default(uuid())
  userId      String
  companyId   String
  date        DateTime
  content     Json
  createdAt   DateTime  @default(now())
  viewedAt    DateTime?
  dismissedAt DateTime?

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@map("daily_digests")
}

model FollowUp {
  id             String    @id @default(uuid())
  userId         String
  companyId      String
  conversationId String
  title          String
  content        String    @db.Text
  scheduledFor   DateTime
  completed      Boolean   @default(false)
  completedAt    DateTime?
  createdAt      DateTime  @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  company      Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("follow_ups")
}

model ConversationMemory {
  id             String     @id @default(uuid())
  userId         String
  companyId      String
  conversationId String?
  type           MemoryType
  title          String
  content        String     @db.Text
  metadata       Json?
  createdAt      DateTime   @default(now())
  lastAccessed   DateTime   @default(now()) @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  company      Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  conversation Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)

  @@map("conversation_memories")
}

enum MemoryType {
  GOAL
  DECISION
  CHALLENGE
  PATTERN
  RELATIONSHIP
  PREFERENCE
}

model EmailDraft {
  id              String      @id @default(uuid())
  userId          String
  emailId         String?     @unique
  threadId        String?
  subject         String?
  content         String      @db.Text
  tone            String?
  status          DraftStatus @default(DRAFT)
  originalEmail   Json?
  metadata        Json?
  isAutoGenerated Boolean     @default(false)
  generatedAt     DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  user         User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  email        Email? @relation("EmailDraftEmailLink", fields: [emailId], references: [id], onDelete: SetNull)
  draftedEmail Email? @relation("EmailDraftLink")

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("email_drafts")
}

model Email {
  id         String        @id @default(uuid())
  companyId  String
  userId     String
  messageId  String        @unique
  threadId   String
  from       String
  to         String[]
  cc         String[]
  subject    String
  body       String        @db.Text
  snippet    String
  receivedAt DateTime
  priority   EmailPriority @default(NORMAL)
  status     EmailStatus   @default(UNREAD)
  isExternal Boolean       @default(true)
  draftId    String?       @unique
  metadata   Json?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  company      Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  draft        EmailDraft?          @relation("EmailDraftLink", fields: [draftId], references: [id], onDelete: SetNull)
  draftFrom    EmailDraft?          @relation("EmailDraftEmailLink")
  interactions ContactInteraction[]

  @@index([companyId])
  @@index([userId])
  @@index([threadId])
  @@index([receivedAt])
  @@index([status])
  @@map("emails")
}

enum DraftStatus {
  DRAFT
  SENT
  REVISED
}

enum EmailPriority {
  URGENT
  HIGH
  NORMAL
  LOW
}

enum EmailStatus {
  UNREAD
  DRAFT_READY
  RESPONDED
  ARCHIVED
  SNOOZED
  DELETED
}

model Contact {
  id            String          @id @default(uuid())
  userId        String
  companyId     String
  email         String
  name          String
  company       String?
  title         String?
  category      ContactCategory @default(OTHER)
  vipStatus     Boolean         @default(false)
  notes         String?         @db.Text
  metadata      Json?
  lastContactAt DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyModel Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  interactions ContactInteraction[]

  @@unique([userId, email])
  @@index([companyId])
  @@map("contacts")
}

model ContactInteraction {
  id        String          @id @default(uuid())
  contactId String
  type      InteractionType
  subject   String?
  summary   String?         @db.Text
  emailId   String?
  eventId   String?
  timestamp DateTime
  metadata  Json?
  createdAt DateTime        @default(now())

  contact Contact        @relation(fields: [contactId], references: [id], onDelete: Cascade)
  email   Email?         @relation(fields: [emailId], references: [id], onDelete: SetNull)
  event   CalendarEvent? @relation(fields: [eventId], references: [id], onDelete: SetNull)

  @@index([contactId])
  @@index([emailId])
  @@index([eventId])
  @@map("contact_interactions")
}

enum ContactCategory {
  INVESTOR
  BOARD_MEMBER
  CUSTOMER
  PARTNER
  TEAM
  ADVISOR
  VENDOR
  OTHER
}

enum InteractionType {
  EMAIL_SENT
  EMAIL_RECEIVED
  MEETING
  CALL
  NOTE
}

model BoardReport {
  id          String       @id @default(uuid())
  companyId   String
  userId      String
  title       String
  format      ReportFormat
  structure   String?
  focusAreas  String[]
  content     Json
  fileUrl     String?
  status      ReportStatus @default(GENERATING)
  metadata    Json?
  generatedAt DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([userId])
  @@index([status])
  @@map("board_reports")
}

enum ReportFormat {
  PDF
  POWERPOINT
  WORD
  GOOGLE_SLIDES
}

enum ReportStatus {
  GENERATING
  READY
  EDITED
  FINALIZED
}

model Insight {
  id          String   @id @default(uuid())
  companyId   String
  title       String
  description String   @db.Text
  category    String
  priority    Int      @default(1)
  sourceData  Json
  dismissed   Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@index([companyId])
  @@index([dismissed])
  @@index([createdAt])
  @@map("insights")
}
