generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id        String   @id @default(uuid())
  name      String
  industry  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users            User[]
  integrations     Integration[]
  documents        Document[]
  knowledgeEntries KnowledgeEntry[]
  conversations    Conversation[]
  boardReports     BoardReport[]

  @@map("companies")
}

model User {
  id                String   @id @default(uuid())
  email             String   @unique
  name              String
  passwordHash      String?
  role              UserRole @default(CSUITE)
  companyId         String
  emailStyleProfile Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  company            Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  conversations      Conversation[]
  emailDrafts        EmailDraft[]
  boardReports       BoardReport[]
  monthlyTokenUsage  UserMonthlyUsage[]

  @@index([companyId])
  @@index([email])
  @@map("users")
}

model UserMonthlyUsage {
  id           String   @id @default(uuid())
  userId       String
  monthStart   DateTime
  outputTokens Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, monthStart])
  @@index([monthStart])
  @@map("user_monthly_usage")
}

enum UserRole {
  OWNER
  CSUITE
  DEPARTMENT_HEAD
  EMPLOYEE
}

model Integration {
  id            String            @id @default(uuid())
  companyId     String
  platform      Platform
  credentials   String
  status        IntegrationStatus @default(CONNECTED)
  lastSyncAt    DateTime?
  syncFrequency String            @default("realtime")
  metadata      Json?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  company   Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  documents Document[]

  @@unique([companyId, platform])
  @@index([companyId])
  @@index([status])
  @@map("integrations")
}

enum Platform {
  GOOGLE_WORKSPACE
  MICROSOFT_365
  SLACK
  GMAIL
  OUTLOOK
  SALESFORCE
  HUBSPOT
  QUICKBOOKS
  XERO
}

enum IntegrationStatus {
  CONNECTED
  SYNCING
  ERROR
  DISCONNECTED
}

model Document {
  id              String   @id @default(uuid())
  companyId       String
  integrationId   String
  externalId      String
  title           String
  content         String   @db.Text
  contentType     String
  sourceUrl       String?
  metadata        Json
  authorityWeight Float    @default(1.0)
  isExcluded      Boolean  @default(false)
  createdAt       DateTime
  updatedAt       DateTime

  company          Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  integration      Integration      @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  knowledgeEntries KnowledgeEntry[]

  @@unique([integrationId, externalId])
  @@index([companyId])
  @@index([integrationId])
  @@index([isExcluded])
  @@map("documents")
}

model KnowledgeEntry {
  id              String   @id @default(uuid())
  companyId       String
  documentId      String?
  content         String   @db.Text
  embedding       String
  dataType        DataType
  authorityWeight Float    @default(1.0)
  version         Int      @default(1)
  metadata        Json?
  createdAt       DateTime @default(now())

  company  Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  document Document? @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([dataType])
  @@index([documentId])
  @@map("knowledge_entries")
}

enum DataType {
  FINANCIAL
  STRATEGIC
  PRODUCT
  OPERATIONAL
  COMMUNICATION
}

model Conversation {
  id             String   @id @default(uuid())
  companyId      String
  userId         String
  title          String?
  messages       Json
  useSecondBrain Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([userId])
  @@index([updatedAt])
  @@map("conversations")
}

model EmailDraft {
  id            String      @id @default(uuid())
  userId        String
  threadId      String?
  subject       String?
  content       String      @db.Text
  tone          String?
  status        DraftStatus @default(DRAFT)
  originalEmail Json?
  metadata      Json?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("email_drafts")
}

enum DraftStatus {
  DRAFT
  SENT
  REVISED
}

model BoardReport {
  id          String       @id @default(uuid())
  companyId   String
  userId      String
  title       String
  format      ReportFormat
  structure   String?
  focusAreas  String[]
  content     Json
  fileUrl     String?
  status      ReportStatus @default(GENERATING)
  metadata    Json?
  generatedAt DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([userId])
  @@index([status])
  @@map("board_reports")
}

enum ReportFormat {
  PDF
  POWERPOINT
  WORD
  GOOGLE_SLIDES
}

enum ReportStatus {
  GENERATING
  READY
  EDITED
  FINALIZED
}

model Insight {
  id          String   @id @default(uuid())
  companyId   String
  title       String
  description String   @db.Text
  category    String
  priority    Int      @default(1)
  sourceData  Json
  dismissed   Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@index([companyId])
  @@index([dismissed])
  @@index([createdAt])
  @@map("insights")
}
